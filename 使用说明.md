# Claude Code Router ä½¿ç”¨è¯´æ˜

## ğŸ“– é¡¹ç›®ç®€ä»‹

Claude Code Router æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥å°† Claude Code çš„è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„ AI æ¨¡å‹æä¾›å•†ï¼Œå¹¶æ”¯æŒè‡ªå®šä¹‰è¯·æ±‚å’Œå“åº”ã€‚å®ƒå…è®¸æ‚¨åœ¨æ²¡æœ‰ Anthropic è´¦å·çš„æƒ…å†µä¸‹ä½¿ç”¨ Claude Codeï¼ŒåŒæ—¶å¯ä»¥äº«å—æ›´ä½æˆæœ¬çš„ AI æœåŠ¡ã€‚

### âœ¨ ä¸»è¦åŠŸèƒ½

- **æ¨¡å‹è·¯ç”±**: æ ¹æ®ä»»åŠ¡ç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€é€‚åˆçš„æ¨¡å‹ï¼ˆåå°ä»»åŠ¡ã€æ€è€ƒã€é•¿ä¸Šä¸‹æ–‡ç­‰ï¼‰
- **å¤šæä¾›å•†æ”¯æŒ**: æ”¯æŒ OpenRouterã€DeepSeekã€Ollamaã€Geminiã€Volcengineã€SiliconFlow ç­‰
- **è¯·æ±‚/å“åº”è½¬æ¢**: ä½¿ç”¨è½¬æ¢å™¨ç¡®ä¿ä¸åŒæä¾›å•† API çš„å…¼å®¹æ€§
- **åŠ¨æ€æ¨¡å‹åˆ‡æ¢**: åœ¨ Claude Code ä¸­ä½¿ç”¨ `/model` å‘½ä»¤å®æ—¶åˆ‡æ¢æ¨¡å‹
- **GitHub Actions é›†æˆ**: åœ¨ CI/CD æµç¨‹ä¸­ä½¿ç”¨ Claude Code
- **æ’ä»¶ç³»ç»Ÿ**: æ”¯æŒè‡ªå®šä¹‰è½¬æ¢å™¨æ‰©å±•åŠŸèƒ½

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…

é¦–å…ˆç¡®ä¿æ‚¨å·²å®‰è£… Claude Codeï¼š

```bash
npm install -g @anthropic-ai/claude-code
```

ç„¶åå®‰è£… Claude Code Routerï¼š

```bash
npm install -g @musistudio/claude-code-router
```

### 2. é…ç½®

åˆ›å»ºé…ç½®æ–‡ä»¶ `~/.claude-code-router/config.json`ï¼š

```json
{
  "APIKEY": "your-secret-key",
  "PROXY_URL": "http://127.0.0.1:7890",
  "LOG": true,
  "HOST": "0.0.0.0",
  "Providers": [
    {
      "name": "deepseek",
      "api_base_url": "https://api.deepseek.com/chat/completions",
      "api_key": "sk-xxx",
      "models": ["deepseek-chat", "deepseek-reasoner"],
      "transformer": {
        "use": ["deepseek"],
        "deepseek-chat": { "use": ["tooluse"] }
      }
    },
    {
      "name": "openrouter",
      "api_base_url": "https://openrouter.ai/api/v1/chat/completions",
      "api_key": "sk-xxx",
      "models": [
        "google/gemini-2.5-pro-preview",
        "anthropic/claude-3.5-sonnet"
      ],
      "transformer": { "use": ["openrouter"] }
    },
    {
      "name": "ollama",
      "api_base_url": "http://localhost:11434/v1/chat/completions",
      "api_key": "ollama",
      "models": ["qwen2.5-coder:latest"]
    }
  ],
  "Router": {
    "default": "deepseek,deepseek-chat",
    "background": "ollama,qwen2.5-coder:latest",
    "think": "deepseek,deepseek-reasoner",
    "longContext": "openrouter,google/gemini-2.5-pro-preview"
  }
}
```

### 3. å¯åŠ¨ä½¿ç”¨

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Claude Codeï¼š

```bash
ccr code
```

## ğŸ“‹ é…ç½®è¯¦è§£

### å…¨å±€é…ç½®é¡¹

- **`APIKEY`** (å¯é€‰): è®¾ç½®è®¿é—®å¯†é’¥ï¼Œç”¨äºèº«ä»½éªŒè¯
- **`PROXY_URL`** (å¯é€‰): è®¾ç½®ä»£ç†æœåŠ¡å™¨åœ°å€
- **`LOG`** (å¯é€‰): å¯ç”¨æ—¥å¿—è®°å½•ï¼Œæ—¥å¿—æ–‡ä»¶ä½äº `$HOME/.claude-code-router.log`
- **`HOST`** (å¯é€‰): è®¾ç½®æœåŠ¡ç›‘å¬åœ°å€ï¼Œæœªè®¾ç½® APIKEY æ—¶å¼ºåˆ¶ä¸º `127.0.0.1`

### Providers é…ç½®

æ¯ä¸ªæä¾›å•†éœ€è¦é…ç½®ä»¥ä¸‹å­—æ®µï¼š

- **`name`**: æä¾›å•†å”¯ä¸€åç§°
- **`api_base_url`**: API ç«¯ç‚¹åœ°å€
- **`api_key`**: API å¯†é’¥
- **`models`**: å¯ç”¨æ¨¡å‹åˆ—è¡¨
- **`transformer`** (å¯é€‰): è¯·æ±‚/å“åº”è½¬æ¢å™¨

### Router é…ç½®

è·¯ç”±è§„åˆ™å®šä¹‰ä¸åŒåœºæ™¯ä½¿ç”¨çš„æ¨¡å‹ï¼š

- **`default`**: é»˜è®¤æ¨¡å‹ï¼Œç”¨äºä¸€èˆ¬ä»»åŠ¡
- **`background`**: åå°ä»»åŠ¡æ¨¡å‹ï¼Œé€šå¸¸ä½¿ç”¨è¾ƒå°çš„æœ¬åœ°æ¨¡å‹èŠ‚çœæˆæœ¬
- **`think`**: æ€è€ƒæ¨¡å‹ï¼Œç”¨äºæ¨ç†å¯†é›†å‹ä»»åŠ¡
- **`longContext`**: é•¿ä¸Šä¸‹æ–‡æ¨¡å‹ï¼Œå¤„ç†è¶…è¿‡ 60K token çš„å¯¹è¯

## ğŸ”§ è½¬æ¢å™¨ (Transformers)

è½¬æ¢å™¨ç”¨äºå¤„ç†ä¸åŒæä¾›å•† API çš„å…¼å®¹æ€§é—®é¢˜ã€‚

### å†…ç½®è½¬æ¢å™¨

- **`deepseek`**: é€‚é… DeepSeek API
- **`gemini`**: é€‚é… Gemini API
- **`openrouter`**: é€‚é… OpenRouter API
- **`groq`**: é€‚é… Groq API
- **`maxtoken`**: è®¾ç½®æœ€å¤§ token æ•°
- **`tooluse`**: ä¼˜åŒ–å·¥å…·è°ƒç”¨
- **`gemini-cli`** (å®éªŒæ€§): é€šè¿‡ Gemini CLI æ”¯æŒ

## ğŸ”„ API Key è½®è¯¢åŠŸèƒ½

Claude Code Router ç°åœ¨æ”¯æŒå¤šä¸ª API Key è½®è¯¢åŠŸèƒ½ï¼Œå¯ä»¥è‡ªåŠ¨åœ¨å¤šä¸ª API Key ä¹‹é—´åˆ‡æ¢ï¼Œæé«˜å¯ç”¨æ€§å’Œè´Ÿè½½å‡è¡¡ã€‚

### é…ç½®æ–¹å¼

#### 1. åŸºæœ¬è½®è¯¢é…ç½®
```json
{
  "name": "deepseek",
  "api_base_url": "https://api.deepseek.com/chat/completions",
  "api_keys": ["sk-xxx1", "sk-xxx2", "sk-xxx3"],
  "enable_rotation": true,
  "rotation_strategy": "round_robin",
  "models": ["deepseek-chat", "deepseek-reasoner"]
}
```

#### 2. é«˜çº§è½®è¯¢é…ç½®
```json
{
  "name": "openrouter",
  "api_base_url": "https://openrouter.ai/api/v1/chat/completions",
  "api_keys": [
    {
      "key": "sk-xxx1",
      "weight": 2,
      "maxFailures": 5,
      "cooldownTime": 60000
    },
    {
      "key": "sk-xxx2",
      "weight": 1,
      "maxFailures": 3,
      "cooldownTime": 30000
    }
  ],
  "enable_rotation": true,
  "rotation_strategy": "weighted",
  "retry_on_failure": true,
  "max_retries": 3,
  "models": ["google/gemini-2.5-pro-preview"]
}
```

### è½®è¯¢ç­–ç•¥

- **`round_robin`** (é»˜è®¤): è½®è¯¢æ–¹å¼ï¼ŒæŒ‰é¡ºåºä½¿ç”¨æ¯ä¸ªAPI Key
- **`random`**: éšæœºé€‰æ‹©API Key
- **`weighted`**: åŠ æƒè½®è¯¢ï¼Œæ ¹æ®æƒé‡åˆ†é…è¯·æ±‚
- **`least_used`**: æœ€å°‘ä½¿ç”¨ä¼˜å…ˆ

### é…ç½®å‚æ•°è¯´æ˜

- **`api_keys`**: API Key åˆ—è¡¨ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æ•°ç»„æˆ–å¯¹è±¡æ•°ç»„
- **`enable_rotation`**: æ˜¯å¦å¯ç”¨è½®è¯¢åŠŸèƒ½ (é»˜è®¤: true)
- **`rotation_strategy`**: è½®è¯¢ç­–ç•¥ (é»˜è®¤: round_robin)
- **`retry_on_failure`**: å¤±è´¥æ—¶æ˜¯å¦é‡è¯• (é»˜è®¤: true)
- **`max_retries`**: æœ€å¤§é‡è¯•æ¬¡æ•° (é»˜è®¤: 3)

#### API Key å¯¹è±¡é…ç½®
- **`key`**: API Key å­—ç¬¦ä¸²
- **`weight`**: æƒé‡ï¼Œç”¨äºåŠ æƒè½®è¯¢ (é»˜è®¤: 1)
- **`maxFailures`**: æœ€å¤§å¤±è´¥æ¬¡æ•°ï¼Œè¶…è¿‡åç¦ç”¨è¯¥Key
- **`cooldownTime`**: å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œå¤±è´¥åç­‰å¾…æ—¶é—´

### ç›‘æ§å’Œç®¡ç†

#### æŸ¥çœ‹è½®è¯¢çŠ¶æ€
```bash
# æŸ¥çœ‹åŸºæœ¬çŠ¶æ€ï¼ˆåŒ…å«è½®è¯¢ä¿¡æ¯ï¼‰
ccr status

# æŸ¥çœ‹è¯¦ç»†è½®è¯¢çŠ¶æ€
ccr rotation
```

#### çŠ¶æ€ä¿¡æ¯è¯´æ˜
- **Total Keys**: æ€»API Keyæ•°é‡
- **Available Keys**: å½“å‰å¯ç”¨çš„API Keyæ•°é‡
- **Key Status**: æ¯ä¸ªAPI Keyçš„çŠ¶æ€
  - âœ… æ´»è·ƒçŠ¶æ€
  - âŒ ç¦ç”¨çŠ¶æ€ï¼ˆè¶…è¿‡æœ€å¤§å¤±è´¥æ¬¡æ•°ï¼‰
  - å¤±è´¥æ¬¡æ•°æ˜¾ç¤º

### é”™è¯¯å¤„ç†

- **è‡ªåŠ¨é‡è¯•**: å½“API Keyå¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çš„Key
- **å¤±è´¥è®¡æ•°**: è®°å½•æ¯ä¸ªKeyçš„å¤±è´¥æ¬¡æ•°
- **å†·å´æœºåˆ¶**: å¤±è´¥çš„Keyä¼šè¿›å…¥å†·å´æœŸï¼Œé¿å…é¢‘ç¹é‡è¯•
- **è‡ªåŠ¨æ¢å¤**: æˆåŠŸçš„è¯·æ±‚ä¼šé‡ç½®å¤±è´¥è®¡æ•°

### å‘åå…¼å®¹

ç°æœ‰çš„å•API Keyé…ç½®ä»ç„¶å®Œå…¨æ”¯æŒï¼š
```json
{
  "name": "ollama",
  "api_base_url": "http://localhost:11434/v1/chat/completions",
  "api_key": "ollama",
  "models": ["qwen2.5-coder:latest"]
}
```

### è½¬æ¢å™¨é…ç½®ç¤ºä¾‹

**å…¨å±€è½¬æ¢å™¨**ï¼š
```json
{
  "name": "openrouter",
  "transformer": { "use": ["openrouter"] }
}
```

**æ¨¡å‹ç‰¹å®šè½¬æ¢å™¨**ï¼š
```json
{
  "name": "deepseek",
  "transformer": {
    "use": ["deepseek"],
    "deepseek-chat": { "use": ["tooluse"] }
  }
}
```

**å¸¦å‚æ•°çš„è½¬æ¢å™¨**ï¼š
```json
{
  "name": "siliconflow",
  "transformer": {
    "use": [
      ["maxtoken", { "max_tokens": 16384 }]
    ]
  }
}
```

## ğŸ® ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
ccr start

# åœæ­¢æœåŠ¡
ccr stop

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
ccr status

# æ‰§è¡Œä»£ç å‘½ä»¤
ccr code

# æŸ¥çœ‹ç‰ˆæœ¬
ccr -v

# æŸ¥çœ‹å¸®åŠ©
ccr -h
```

### åŠ¨æ€æ¨¡å‹åˆ‡æ¢

åœ¨ Claude Code ä¸­ä½¿ç”¨ `/model` å‘½ä»¤åˆ‡æ¢æ¨¡å‹ï¼š

```
/model provider_name,model_name
```

ç¤ºä¾‹ï¼š
```
/model openrouter,anthropic/claude-3.5-sonnet
/model deepseek,deepseek-reasoner
```

### ä¼ é€’å‚æ•°ç»™ Claude Code

**å…³äº `--dangerously-skip-permissions` å‚æ•°**ï¼š

Claude Code Router æ”¯æŒå°†ä»»ä½•å‚æ•°ä¼ é€’ç»™åŸå§‹çš„ Claude Codeã€‚æ‚¨å¯ä»¥åœ¨ `ccr code` å‘½ä»¤åæ·»åŠ ä»»ä½• Claude Code æ”¯æŒçš„å‚æ•°ï¼š

```bash
# ä½¿ç”¨ --dangerously-skip-permissions å‚æ•°
ccr code --dangerously-skip-permissions

# ä¼ é€’å…¶ä»–å‚æ•°
ccr code --help
ccr code "å†™ä¸€ä¸ª Hello World ç¨‹åº"
```

## ğŸ” å¸¸è§é—®é¢˜è§£ç­”

### Q: Gemini æ˜¯å¦æ”¯æŒå¤šä¸ª API Key è½®è¯¢ï¼Ÿ

**A**: **æ˜¯çš„ï¼** ç°åœ¨ Claude Code Router å®Œå…¨æ”¯æŒå¤šä¸ª API Key è½®è¯¢åŠŸèƒ½ã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é…ç½®ï¼š

#### åŸºæœ¬è½®è¯¢é…ç½®
```json
{
  "name": "gemini",
  "api_base_url": "https://generativelanguage.googleapis.com/v1beta/models/",
  "api_keys": ["sk-xxx1", "sk-xxx2", "sk-xxx3"],
  "enable_rotation": true,
  "rotation_strategy": "round_robin",
  "models": ["gemini-2.5-flash", "gemini-2.5-pro"]
}
```

#### é«˜çº§è½®è¯¢é…ç½®
```json
{
  "name": "gemini",
  "api_base_url": "https://generativelanguage.googleapis.com/v1beta/models/",
  "api_keys": [
    {
      "key": "sk-xxx1",
      "weight": 2,
      "maxFailures": 5,
      "cooldownTime": 60000
    },
    {
      "key": "sk-xxx2",
      "weight": 1,
      "maxFailures": 3,
      "cooldownTime": 30000
    }
  ],
  "enable_rotation": true,
  "rotation_strategy": "weighted",
  "retry_on_failure": true,
  "max_retries": 3,
  "models": ["gemini-2.5-flash", "gemini-2.5-pro"]
}
```

#### æ”¯æŒçš„è½®è¯¢ç­–ç•¥
- **`round_robin`**: è½®è¯¢æ–¹å¼ï¼ŒæŒ‰é¡ºåºä½¿ç”¨æ¯ä¸ªAPI Key
- **`random`**: éšæœºé€‰æ‹©API Key
- **`weighted`**: åŠ æƒè½®è¯¢ï¼Œæ ¹æ®æƒé‡åˆ†é…è¯·æ±‚
- **`least_used`**: æœ€å°‘ä½¿ç”¨ä¼˜å…ˆ

#### ç›‘æ§è½®è¯¢çŠ¶æ€
```bash
# æŸ¥çœ‹åŸºæœ¬çŠ¶æ€
ccr status

# æŸ¥çœ‹è¯¦ç»†è½®è¯¢çŠ¶æ€
ccr rotation
```

### Q: å¦‚ä½•å¯ç”¨ `--dangerously-skip-permissions` å‚æ•°ï¼Ÿ

**A**: ç›´æ¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
ccr code --dangerously-skip-permissions
```

Claude Code Router ä¼šå°†æ‰€æœ‰å‚æ•°ç›´æ¥ä¼ é€’ç»™åŸå§‹çš„ Claude Codeï¼Œå› æ­¤æ”¯æŒæ‰€æœ‰ Claude Code çš„åŸç”Ÿå‚æ•°ã€‚

### Q: å¦‚ä½•æŸ¥çœ‹æ—¥å¿—ï¼Ÿ

**A**: åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `"LOG": true`ï¼Œæ—¥å¿—æ–‡ä»¶å°†ä¿å­˜åœ¨ `$HOME/.claude-code-router.log`ã€‚

### Q: å¦‚ä½•é…ç½®ä»£ç†ï¼Ÿ

**A**: åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  `PROXY_URL` å­—æ®µï¼š

```json
{
  "PROXY_URL": "http://127.0.0.1:7890"
}
```

### Q: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰è½¬æ¢å™¨ï¼Ÿ

**A**: åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  `transformers` å­—æ®µï¼š

```json
{
  "transformers": [
    {
      "path": "$HOME/.claude-code-router/plugins/custom-transformer.js",
      "options": {
        "customOption": "value"
      }
    }
  ]
}
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### æœåŠ¡å¯åŠ¨å¤±è´¥

1. æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ API Key æ˜¯å¦æœ‰æ•ˆ
3. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œä»£ç†è®¾ç½®
4. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

### æ¨¡å‹åˆ‡æ¢ä¸ç”Ÿæ•ˆ

1. ç¡®è®¤æ¨¡å‹åç§°æ ¼å¼æ­£ç¡®ï¼š`provider_name,model_name`
2. æ£€æŸ¥æä¾›å•†é…ç½®æ˜¯å¦æ­£ç¡®
3. éªŒè¯æ¨¡å‹æ˜¯å¦åœ¨æä¾›å•†çš„æ”¯æŒåˆ—è¡¨ä¸­

### å·¥å…·è°ƒç”¨å¤±è´¥

1. ç¡®è®¤æ¨¡å‹æ”¯æŒå·¥å…·è°ƒç”¨åŠŸèƒ½
2. æ£€æŸ¥æ˜¯å¦é…ç½®äº† `tooluse` è½¬æ¢å™¨
3. éªŒè¯å·¥å…·å®šä¹‰æ ¼å¼æ˜¯å¦æ­£ç¡®

## ğŸ“š è¿›é˜¶ç”¨æ³•

### GitHub Actions é›†æˆ

åœ¨ `.github/workflows/claude.yaml` ä¸­é…ç½®ï¼š

```yaml
name: Claude Code

on:
  issue_comment:
    types: [created]

jobs:
  claude:
    if: contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Environment
        run: |
          curl -fsSL https://bun.sh/install | bash
          mkdir -p $HOME/.claude-code-router
          cat << 'EOF' > $HOME/.claude-code-router/config.json
          {
            "log": true,
            "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
            "OPENAI_BASE_URL": "https://api.deepseek.com",
            "OPENAI_MODEL": "deepseek-chat"
          }
          EOF

      - name: Start Claude Code Router
        run: |
          nohup ~/.bun/bin/bunx @musistudio/claude-code-router@1.0.8 start &

      - name: Run Claude Code
        uses: anthropics/claude-code-action@beta
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
        with:
          anthropic_api_key: "any-string-is-ok"
```

### Docker éƒ¨ç½²

ä½¿ç”¨æä¾›çš„ `docker-compose.yml`ï¼š

```bash
docker-compose up -d
```

## ğŸ”— ç›¸å…³é“¾æ¥

- [é¡¹ç›® GitHub ä»“åº“](https://github.com/musistudio/claude-code-router)
- [Claude Code å®˜æ–¹æ–‡æ¡£](https://docs.anthropic.com/en/docs/claude-code/quickstart)
- [é¡¹ç›®åŠ¨æœºå’Œå·¥ä½œåŸç†](blog/zh/é¡¹ç›®åˆè¡·åŠåŸç†.md)
- [æˆ–è®¸æˆ‘ä»¬èƒ½åœ¨Routerä¸­åšæ›´å¤šäº‹æƒ…](blog/zh/æˆ–è®¸æˆ‘ä»¬èƒ½åœ¨Routerä¸­åšæ›´å¤šäº‹æƒ….md)

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚ 